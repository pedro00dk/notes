version: '3.8'

services:
    # mongodb and related services
    mongo:
        image: mongo
        command: mongod --port 10000
        ports:
            - 10000:10000
        volumes:
            - ./database/:/docker-entrypoint-initdb.d/
            - ./database/data/:/data/db/
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: pass
            MONGO_INITDB_DATABASE: chat
            MONGO_COLLECTIONS: |
                ["user", "message"]
            MONGO_USERS: |
                [{"user": "user", "pwd": "pass"}]
    mongo-ui:
        image: mongo-express
        restart: unless-stopped
        ports:
            - 10100:10100
        environment:
            VCAP_APP_PORT: 10100
            ME_CONFIG_MONGODB_URL: mongodb://root:pass@mongo:10000/
        depends_on:
            - mongo

    # kafka and related services
    zookeeper:
        image: 'confluentinc/cp-zookeeper:7.0.1'
        ports:
            - 11100:11100
        environment:
            ZOOKEEPER_CLIENT_PORT: 11100
            ALLOW_ANONYMOUS_LOGIN: yes
    kafka:
        image: confluentinc/cp-kafka:7.0.1
        depends_on:
            - zookeeper
        ports:
            - 11010:11010
        environment:
            KAFKA_BROKER_ID: 0
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:11100
            KAFKA_ADVERTISED_LISTENERS: DOCKER://kafka:11000,HOST://localhost:11010
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: DOCKER:PLAINTEXT,HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: DOCKER
    kafka-ui:
        image: provectuslabs/kafka-ui
        depends_on:
            - zookeeper
            - kafka
        ports:
            - 11200:11200
        environment:
            SERVER_PORT: 11200
            KAFKA_CLUSTERS_0_NAME: kafka
            KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:11100
            KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:11000

    # application containers
    backend:
        build:
            context: ./backend/
            dockerfile: dockerfile.development
        depends_on:
            - mongo
            - kafka
        ports:
            - 3000:12000
        volumes:
            - ./backend/:/app/
        environment:
            SERVER_PORT: 12000
            MONGO_URL: mongodb://root:pass@mongo:10000/
            MONGO_DB: chat
            KAFKA_BROKERS: kafka:11000
            KAFKA_TOPIC: foo
            KAFKA_CREATE: true
