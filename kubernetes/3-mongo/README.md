## Example 3: Mongo

> **Ingress**
>
> A Kubernetes Ingress is another alternative for handling external networking on a cluster. Different from external services, an ingress can only handle http request on default ports (80 for http, 443 for https), but it allows flexible routing features such as domain and path matching.
>
> The external http ports (80, 443) will be open at the cluster's master nodes, where an ingress controller will resolve the rules and redirect the request to a service, usually internal services are used together with ingresses.

[0-deployment-service.yaml](./0-configmap.yaml) describes a deployment of multi-container pods containing mongodb and express, and an internal service that provides access to the pod. The overall configuration is simplified since the focus is the Kubernetes ingress.

[1-ingress.yaml](./1-ingress.yaml) describes an ingress configuration with two paths, one for mongo and another for express.

The ingress resource generated by its configuration alone will have not effect. An **ingress-controller** needs to be deployed into the cluster as well. The controller will resolve the ingress rules.

On a minikube cluster, an ingress controller can be easily installed with `minikube addons enable ingress`. An nginx based ingress controller will be installed. Cloud providers will require different procedures in order to set up an ingress controller within the cluster.

```shell
$ # installing the ingress controller (minikube, only needs to be done once per cluster)
$ # the ingress controller can be uninstalled with the command: minikube addons disable ingress
$ minikube addons enable ingress
    ▪ Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
    ▪ Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
    ▪ Using image k8s.gcr.io/ingress-nginx/controller:v1.1.1
  Verifying ingress addon...
  The 'ingress' addon is enabled

$ # creating the deployment and its service
$ kubectl apply --filename 0-deployment-service.yaml
deployment.apps/mongo-express created
service/mongo-express created

$ # creating ingress
$ kubectl apply --filename 1-ingress.yaml
ingress.networking.k8s.io/mongo-express created
```

The simplest ingress configurations do not require a _host_ definition, when a host is not provided connections from any domain (or without domain, IP provided) will resolve successfully and its path is going to be matched against the ingress rules.

[1-ingress.yaml](./1-ingress.yaml) does not contain a host definition. Any client will be able access the cluster ingress without host checking. The ingress entrypoint is only accessible through a cluster`s master nodes.

```shell
$ # minikube provides the ip of the master node
$ minikube ip
192.168.49.2

$ # kubectl can provide the ip of all nodes
$ kubectl get nodes --output wide
NAME           ...   INTERNAL-IP    ...
minikube       ...   192.168.49.2   ...
minikube-m02   ...   192.168.49.3   ...
minikube-m03   ...   192.168.49.4   ...

$ # accessing the ingress controller
$ curl 192.168.49.2
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>

$ # accessing mongodb
$ curl 192.168.49.2/database
It looks like you are trying to access MongoDB over HTTP on the native driver port.

$ # accessing express
$ curl root:pass@192.168.49.2/dashboard
<!DOCTYPE html>
<html lang="en">
<head>
  ...
  <title>Home - Mongo Express</title>
  ...
</head>
<body>
  ...
</body>
</html>
```

### Ingress Host

[2-ingress-with-host.yaml](./2-ingress-with-host.yaml) is similar to [1-ingress.html](./1-ingress.yaml) but it defines two rules, one for each application, and both rules with hosts.

The ingress host is used by the controller and is matched against the _host_ header in http requests. Ingress hosts might contain wildcards as well, allowing multiple subdomains to match the same rule.

For testing purposes we can simulate a request with a host header using curl, but generally the host header is set automatically by the browser when the host name is resolved on a DNS.

```shell
$ # 2-ingress-with-host.yaml configuration will update 1-ingress.yaml if it exists
$ kubectl apply --filename 2-ingress-with-host.yaml
ingress.networking.k8s.io/mongo-express configured

$ # accessing the database fails because host does not match
$ curl 192.168.49.2/database
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>

$ # the request works if the host header is set
$ curl --header host:abc.com 192.168.49.2/database
It looks like you are trying to access MongoDB over HTTP on the native driver port.
```

### Security

An ingress can be secured with a private key and certificate. For more information check the [Kubernetes Ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/) documentation.
